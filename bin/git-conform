#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

begin
  require 'git-conform'
rescue LoadError
  require 'rubygems'
  require 'git-conform'
end

options = Trollop::options do

  version Git::Conform::COPYRIGHT
  banner Git::Conform::BANNER

  opt :list, 'List all conformity checkers for this repo', :short => 'l', :default => false
  opt :verify, 'Verify that all conformity checkers exist', :short => 'c', :default => false

end

repo = begin
  Git::Conform::Repo.new(Git::Conform::Repo.discover(Dir.pwd))
rescue RuntimeError
  unless $!.message =~ /The given path is not a valid Git repository/
    unless $!.message =~ /Not a git repository \(or any of the parent directories\)/
      raise # Rugged uses generic RuntimeErrors, so we have to check the exception messages...
    end
  end
  nil
end

unless repo
  STDERR.puts "fatal: Not a git repository (or any of the parent directories): #{Dir.pwd}"
  exit -1
end

unless repo.git_conform_enabled?
  STDERR.puts "fatal: unable to read config file '#{repo.git_conform_path}': No such file or directory"
  exit -1
end

if options[:list]
  unless repo.conformity_checkers.empty?
    STDOUT.puts repo.conformity_checkers.sort.join("\n")
  end
  exit 0
end

if options[:verify]
  begin
    repo.verify
  rescue NameError
    STDERR.puts "fatal: #{$!.message}"
    exit -1
  end
  exit 0
end

fail "Coming soon!"

# That's all, Folks!